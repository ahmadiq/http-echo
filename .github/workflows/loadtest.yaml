name: Load Test Workflow

on:
  pull_request:
    branches:
      - main

env:
  TAG: http-echo:loadtest
  CLUSTER: echo-cluster

jobs:
  load-test:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build docker image
        run: make docker TAG=$TAG

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          config: ci/kind-config.yaml
          cluster_name: echo-cluster

      - name: Deploy Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait -n ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=90s

      - name: Load Docker Image
        run: kind load docker-image $TAG --name $CLUSTER

      - name: Deploy http-echo service
        run: |
          kubectl create namespace loadtest
          kubectl create -f ci/service-deployment.yaml -n loadtest
          kubectl wait -n loadtest \
             --for=condition=ready pod \
             --all --timeout=90s

      - name: Load Test set up
        uses: grafana/setup-k6-action@v1
        with:
          k6-version: '0.52.0'

      - name: Run Load Test
        uses: grafana/run-k6-action@v1
        with:
          path: ./ci/load-test.js
